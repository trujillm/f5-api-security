# More info on playground configuration can be found here:
# https://llama-stack.readthedocs.io/en/latest/playground

FROM python:3.12-slim

ARG LLAMASTACK_VERSION=0.2.23
WORKDIR /app
COPY . /app/

# LLAMASTACK_VERSION defaults to 0.2.23 but can be overridden with --build-arg LLAMASTACK_VERSION=<version>
RUN echo "Using LlamaStack version: $LLAMASTACK_VERSION"

# Replace __LLAMASTACK_VERSION__ with actual LlamaStack library version in pyproject.toml
RUN sed -i "s/__LLAMASTACK_VERSION__/${LLAMASTACK_VERSION}/g" pyproject.toml

# Install uv
RUN pip install uv

# Set UV cache directory to a writable location
ENV UV_CACHE_DIR=/app/.uv-cache
ENV XDG_CACHE_HOME=/app/.cache

# Create cache directories with proper permissions
RUN mkdir -p /app/.uv-cache /app/.cache && \
    chmod -R 777 /app/.uv-cache /app/.cache

# Install dependencies using uv
RUN if [ -f "uv.lock" ]; then \
        echo "Lockfile found, using frozen sync"; \
        uv sync --frozen; \
    else \
        echo "Lockfile not found, creating new one"; \
        uv sync; \
    fi

# Ensure all app files have proper ownership and permissions for non-root users
RUN chown -R 1001:0 /app && \
    chmod -R g+rwX /app

EXPOSE 8501

ENTRYPOINT ["uv", "run", "streamlit", "run", "/app/llama_stack_ui/distribution/ui/app.py", "--server.port=8501", "--server.address=0.0.0.0"]
